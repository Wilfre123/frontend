<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Modern Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

 <link rel="stylesheet" href="style/style4.css">
</head>
<body>
  <div class="sidebar collapsed" id="sidebar">
    <a href="test.html"><i class="bi bi-house-door-fill"></i><span>Home</span></a>
    <a href="#"><i class="bi bi-upload"></i><span>Submit</span></a>
    <a href="map.html"><i class="bi bi-map "></i><span>Map</span></a>
    <a href="seetings.html"><i class="bi bi-gear-fill"></i><span>Settings</span></a>
  </div>
  <div class="topbar">
    <button class="toggle-btn" onclick="toggleSidebar()"><i class="bi bi-list"></i></button>
    <h5 class="mb-0 fw-bold text-success">Coordinate Dashboard</h5>
  </div>
  <div class="content">
    <div class="row gy-4">
      <div class="col-12 col-md-5">
        <div class="form-container" id="div1">
          <h4 class="text-success fw-bold mb-3">Submit Coordinates</h4>
          <form id="dataForm">
            <div class="mb-3">
              <label class="form-label">Corner</label>
              <input type="text" name="corner" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Latitude</label>
              <input type="number" name="lat" step="any" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Longitude</label>
              <input type="number" name="long" step="any" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-success btn-sm">Submit</button>
          </form>
            <button type="submit" class="btn btn-warning btn-sm mt-3"  onclick="toggleDivs()"><i class="bi bi-table"></i> By table</button>
          </div>

          <div class="form-container" id="div2">
            <h4 class="text-success fw-bold mb-3">Submit Coordinates</h4>
            <form id="dataForm">
         <div class="table_div">    
           <table id="editableTable" aria-label="Editable data table" style="width:100%">
            <thead>
              <tr>
                <th>Corner</th><th>Latitude</th><th>Longitude</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td contenteditable="true" aria-label="Corner"></td>
                <td contenteditable="true" aria-label="Latitude"></td>
                <td contenteditable="true" aria-label="Longitude"></td>
              </tr>
            </tbody>
          </table>
          </div>

            <br>
            <button type="submit"  id="submitBtn" class="btn btn-success btn-sm">Submit</button>
              </form>
            <button type="submit" class="btn btn-warning btn-sm mt-3"  onclick="toggleDivs()"><i class="bi bi-clipboard"></i> By form</button>   
        </div>
        </div>
      <div class="col-12 col-md-7">
        <div class="table-container">
          <h4 class="text-success fw-bold mb-3">Coordinates table</h4>
           <div class=" d-flex justify-content-end">
            <input type="text"  id="searchInput" class="form-control me-5" placeholder="Search">
            <select id="rowCount" class="form-label" onchange="updateRowSelection()">
                <option value="0">Row</option>
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="20">20</option>
                <option value="30">30</option>
                <option value="40">40</option>
            </select>
            </div><br>
            <div style="overflow: auto;">
            <style>
              #myTable th,
              #myTable td {
                text-align: center;       /* horizontal centering */
                vertical-align: middle;   /* vertical centering */
              }
            </style>
           <form id="coordinatesForm">
          
  <table id="myTable" class="table table-bordered table-striped table-responsive">
      <table id="myTable" class="table table-bordered table-striped table-responsive">
        <thead>
          <tr>
            <th class="text-center align-middle">Corner</th>
            <th class="text-center align-middle">Longitude</th>
            <th class="text-center align-middle">Latitude</th>
            <th class="text-center align-middle">Action</th>
          </tr>
        </thead>
        <tbody id="coordinatesTable">
          <tr>
            <td class="text-center align-middle" colspan="4">
              No data
            </td>
          </tr>
        </tbody>
      </table>
  </form>
           </div>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 340px;">
      <div class="modal-content border-success">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">Success!</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <div class="checkmark-container">
            <svg class="checkmark" viewBox="0 0 52 52">
              <circle class="checkmark-circle" cx="26" cy="26" r="25"/>
              <path class="checkmark-check" d="M14 27l7 7 16-16"/>
            </svg>
          </div>
          <p class="mt-3">Coordinates submitted ðŸŽ‰</p>
        </div>
        <div class="modal-footer justify-content-center">
          <button class="btn btn-success px-4" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="script/index.js"></script>
  </body>
  </html>


  <script>
    const insertedDataKeys = new Set();

function createDataKey(data) {
  return `${data.corner || ''}|${data.long}|${data.lat}`;
}

function appendToTable(data) {
  const tbody = document.getElementById('coordinatesTable');
  if (tbody.querySelector('td[colspan]')) {
    tbody.innerHTML = '';
  }

  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>${data.corner || ''}</td>
    <td>${data.long}</td>
    <td>${data.lat}</td>
    <td>
   
    <a href="/delete/${data.id}" class="btn btn-primary btn-sm">
      <i class="bi bi-arrow-clockwise"></i> 
    </a>
   <button type="button" class="btn btn-danger btn-sm delete-btn" data-id="${data.id}">
        <i class="bi bi-trash"></i> 
      </button>
     
    </td>
  `;
  tbody.appendChild(tr);

  tr.querySelector('.delete-btn').addEventListener('click', async () => {
    const id = tr.querySelector('.delete-btn').getAttribute('data-id');
    try {
      const resp = await fetch(`http://localhost:3000/data/${id}`, { method: 'DELETE' });
      if (resp.ok) {
        tr.remove();
        insertedDataKeys.delete(createDataKey(data));
        if (!tbody.children.length) {
          tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No data</td></tr>';
        }
      } else {
        alert('Failed to delete item.');
      }
    } catch (err) {
      alert('Error deleting: ' + err.message);
    }
  });
}

async function fetchData() {
  try {
    const resp = await fetch('http://localhost:3000/data/display_data');
    if (resp.ok) {
      const data = await resp.json();
      data.forEach(item => {
        const key = createDataKey(item);
        insertedDataKeys.add(key);
        appendToTable(item);
      });
    }
  } catch (err) {
    alert('Error fetching data: ' + err.message);
  }
}

document.getElementById('coordinatesForm').addEventListener('submit', async function (e) {
  e.preventDefault();

  const formData = new FormData(this);
  const data = {
    long: parseFloat(formData.get('long')),
    lat: parseFloat(formData.get('lat')),
    corner: formData.get('corner') || ''
  };

  const key = createDataKey(data);
  if (insertedDataKeys.has(key)) {
    alert('Data already inserted.');
    return;
  }

  try {
    const resp = await fetch('http://localhost:3000/data', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    if (resp.ok) {
      const result = await resp.json();
      const successModal = document.getElementById('successModal');
      const modalInstance = bootstrap.Modal.getOrCreateInstance(successModal);
      modalInstance.show();

      insertedDataKeys.add(key);
      appendToTable(result);
      this.reset();
    } else if (resp.status === 409) {
      alert('Data already inserted.');
    } else {
      alert('Submission failed.');
    }
  } catch (err) {
    alert('Server error: ' + err.message);
  }
});

window.addEventListener('load', fetchData);


// shift div1 and div 2 

function toggleDivs() {
  const div1 = document.getElementById("div1");
  const div2 = document.getElementById("div2");

  const div1Display = window.getComputedStyle(div1).display;

  if (div1Display === "block") {
    div1.style.display = "none";
    div2.style.display = "block";
  } else {
    div1.style.display = "block";
    div2.style.display = "none";
  }
}


// script insert table in index.html

 const table = document.getElementById('editableTable');
  const tbody = table.querySelector('tbody');
  let selectedCell = null;

  tbody.addEventListener('focusin', e => {
    if (e.target.tagName === 'TD' && e.target.isContentEditable) {
      selectedCell = e.target;
    }
  });

  tbody.addEventListener('paste', (event) => {
    if (!selectedCell) return;

    event.preventDefault();
    const pasteData = (event.clipboardData || window.clipboardData).getData('text');
    const rows = pasteData.trim().split(/\r\n|\n|\r/).map(row => row.split('\t'));

    const startRow = selectedCell.parentElement.rowIndex - 1;
    const startCol = selectedCell.cellIndex;

    while (tbody.rows.length < startRow + rows.length) {
      const newRow = tbody.insertRow();
      for (let i = 0; i < table.rows[0].cells.length; i++) {
        const newCell = newRow.insertCell();
        newCell.contentEditable = "true";
        newCell.setAttribute('aria-label', table.tHead.rows[0].cells[i].textContent);
      }
    }

    rows.forEach((rowData, rowIndex) => {
      const row = tbody.rows[startRow + rowIndex];
      while (row.cells.length < startCol + rowData.length) {
        const newCell = row.insertCell();
        newCell.contentEditable = "true";
        newCell.setAttribute('aria-label', 'Extra column');
      }

      rowData.forEach((cellData, colIndex) => {
        row.cells[startCol + colIndex].textContent = cellData;
      });
    });
  });

  document.getElementById('submitBtn').addEventListener('click', () => {
    const data = [];
    for (let r = 0; r < tbody.rows.length; r++) {
      const row = tbody.rows[r];
      const rowData = [];
      for (let c = 0; c < row.cells.length; c++) {
        rowData.push(row.cells[c].textContent.trim());
      }
      data.push(rowData);
    }

    fetch('http://localhost:3000/data/more_data', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data),
    })
    .then(response => response.json())
    .then(result => {
      alert('Data submitted successfully!');
      console.log(result);
    })
    .catch(error => {
      alert('Error submitting data');
      console.error(error);
    });
  });
  </script>

